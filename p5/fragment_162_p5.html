<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>wave2</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
      body {
        margin: 0;
        overflow: hidden;
        background-color: #000;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
      }
      canvas {
        display: block;
      }
      .caption {
        position: absolute;
        left: 16px;
        bottom: 16px;
        color: #fff;
        font-family: Helvetica, Arial;
        z-index: 10;
        pointer-events: none;
      }
    </style>
  </head>
  <body>
    <div class="caption">“wave2”</div>
    <script>
      let l, n;
      let t;
      let stars = [];

      function setup() {
        createCanvas(800, 800, WEBGL);
        l = 10;
        n = 50;
        // 背景の星を作成
        for (let i = 0; i < 200; i++) {
          stars.push(
            createVector(
              random(-1000, 1000),
              random(-1000, 1000),
              random(-1000, 1000)
            )
          );
        }
      }

      function draw() {
        t = millis() / 1000;
        background(5, 10, 20); // より深い黒

        // カメラ：ゆっくり上下しながら旋回
        let camX = cos(t * 0.2) * 700;
        let camY = -400 + sin(t * 0.5) * 100;
        let camZ = sin(t * 0.2) * 700;
        camera(camX, camY, camZ, 0, 0, 0, 0, 1, 0);

        // 星屑の描画
        stroke(255, 150);
        strokeWeight(2);
        for (let s of stars) {
          point(s.x, s.y, s.z);
        }

        // 光源
        ambientLight(40);
        pointLight(0, 255, 255, 300, -500, 200);
        pointLight(255, 0, 200, -300, -500, -200);

        let mx = map(mouseX, 0, width, -(l * n) / 2, (l * n) / 2);
        let my = map(mouseY, 0, height, -(l * n) / 2, (l * n) / 2);

        push();
        rotateX(PI / 2);

        // グリッドの描画
        for (let i = 0; i < n; i++) {
          for (let j = 0; j < n; j++) {
            drawDataNode(i, j, mx, my);
          }
        }

        // 波の面（透過させてサイバー感を出す）
        noFill();
        strokeWeight(0.5);
        for (let i = 0; i < n - 1; i++) {
          beginShape(TRIANGLE_STRIP);
          for (let j = 0; j < n; j++) {
            let v = calcWave(i, j, mx, my);
            stroke(v.c, 200, 255, 50);
            vertex(v.x, v.y, v.z);
            let v2 = calcWave(i + 1, j, mx, my);
            vertex(v2.x, v2.y, v2.z);
          }
          endShape();
        }
        pop();
      }

      // 波の高さ計算を分離
      function calcWave(i, j, mx, my) {
        let x = l * i - (l * n) / 2;
        let y = l * j - (l * n) / 2;
        let d1 = dist(0, 0, x, y);
        let z1 = exp(-d1 / 150) * sin(d1 / 15 - t * 2) * 70;
        let d2 = dist(mx, my, x, y);
        let z2 = exp(-d2 / 100) * sin(d2 / 10 - t * 3) * 50;
        let z = z1 + z2;
        let c = map(z, -50, 50, 0, 255);
        return { x, y, z, c };
      }

      // 各点（ノード）と光の柱の描画
      function drawDataNode(i, j, mx, my) {
        let v = calcWave(i, j, mx, my);

        // 一定間隔おきに「光の柱」を描画
        if (i % 4 == 0 && j % 4 == 0) {
          stroke(v.c, 255, 255, 100);
          strokeWeight(1);
          line(v.x, v.y, v.z, v.x, v.y, v.z - 50); // 下方向に伸びる光
        }

        // 頂点のポイント
        stroke(v.c, 100, 255, 200);
        strokeWeight(3);
        point(v.x, v.y, v.z);
      }
    </script>
  </body>
</html>
