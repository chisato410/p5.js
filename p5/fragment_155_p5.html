<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>fire flower</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>
    <script src="https://unpkg.com/p5.brush@1.0.3/dist/p5.brush.min.js"></script>
    <style>
      body {
        margin: 0;
        overflow: hidden;
        background-color: #000;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
      }
      canvas {
        display: block;
      }
      .caption {
        position: absolute;
        left: 16px;
        bottom: 16px;
        color: #fff;
        font-family: Helvetica, Arial;
        z-index: 10;
        pointer-events: none;
      }
    </style>
  </head>
  <body>
    <div class="caption">“fire flower”</div>
    <script>
      let flowers = [];
      let offset;
      let url =
        "https://coolors.co/001219-005f73-0a9396-94d2bd-e9d8a6-ee9b00-ca6702-bb3e03-ae2012-9b2226";
      let palette, texture;

      function setup() {
        createCanvas(800, 800);
        colorMode(HSB, 360, 100, 100, 100);
        angleMode(DEGREES);
        palette = createPalette(url);
        offset = width / 10;
        texture = createGraphics(width, height);
        texture.colorMode(HSB, 360, 100, 100, 100);
        texture.stroke(0, 0, 100, 5);
        for (let i = 0; i < (width * height * 5) / 100; i = i + 1) {
          texture.strokeWeight(random(3));
          texture.point(random(width), random(height));
        }
        frameRate(60);
        setupFlowers();
      }

      function setupFlowers() {
        flowers = [];
        recursiveFlower(offset, offset, width - offset * 2);
      }

      function recursiveFlower(x, y, d) {
        let step = int(random(1, 4));
        let w = d / step;
        for (let j = 0; j < step; j++) {
          for (let i = 0; i < step; i++) {
            let nx = x + i * w;
            let ny = y + j * w;
            if (random(100) < 90 && w > width / 3) {
              recursiveFlower(nx, ny, w);
            } else {
              let f = new Flower(
                createVector(nx + w / 2, ny + w / 2),
                w / sqrt(2),
                shuffle(palette)
              );
              flowers.push(f);
            }
          }
        }
      }

      function draw() {
        blendMode(BLEND);
        background(0, 0, 0, 50);
        blendMode(ADD);
        for (let f of flowers) {
          f.display();
        }
        image(texture, 0, 0);

        if (frameCount % 100 == 0) {
          setupFlowers();
        }
      }

      class Flower {
        constructor(pos, radius, palette) {
          this.pos = createVector(pos.x, pos.y);
          this.radius = radius;
          this.color_list = palette;
          this.noise_seed_deg = random(1000);
          this.noise_seed_radius = random(1000);
          this.frame_param = random(1000);
          this.g = createGraphics(this.radius * 2, this.radius * 2);
          this.g.angleMode(DEGREES);
          this.fan_num = int(random(3, 8)) * 2;
        }
        update() {}
        display() {
          this.g.clear();
          this.g.push();
          // this.g.rect(1, 1, this.g.width - 2, this.g.height - 2);
          this.g.translate(this.g.width / 2, this.g.height / 2);

          for (let k = 0; k < this.color_list.length; k++) {
            this.g.fill(this.color_list[k]);
            this.g.noStroke();

            this.g.beginShape();
            for (let m = 0; m < 15; m++) {
              let angle = map(
                noise(
                  k * 33,
                  this.noise_seed_deg,
                  (this.frame_param + frameCount + m) * 0.005
                ),
                0,
                1,
                -360 * 2,
                360 * 2
              );
              let noise_radius = map(
                noise(
                  k * 67,
                  this.noise_seed_radius,
                  (this.frame_param + frameCount + m) * 0.01
                ),
                0,
                1,
                this.radius * -1,
                this.radius * 1
              );
              this.g.vertex(
                noise_radius * cos(angle),
                noise_radius * sin(angle)
              );
            }
            this.g.endShape();
          }

          this.g.pop();

          push();
          translate(this.pos.x, this.pos.y);
          // drawingContext.shadowColor = color(0,0,100);
          // drawingContext.shadowBlur = this.g.width/2;
          imageMode(CENTER);
          for (let i = 0; i < this.fan_num; i++) {
            rotate(360 / this.fan_num);
            image(this.g, 0, 0);
          }
          pop();
        }
      }

      function createPalette(_url) {
        let slash_index = _url.lastIndexOf("/");
        let pallate_str = _url.slice(slash_index + 1);
        let arr = pallate_str.split("-");
        for (let i = 0; i < arr.length; i++) {
          arr[i] = color("#" + arr[i] + hex(200, 2));
        }
        return arr;
      }
    </script>
  </body>
</html>
