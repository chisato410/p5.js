<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>Kaleidoscope</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
      body {
        margin: 0;
        overflow: hidden;
        background-color: #000;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
      }
      canvas {
        display: block;
      }
      .caption {
        position: absolute;
        left: 16px;
        bottom: 16px;
        color: #fff;
        font-family: Helvetica, Arial;
        z-index: 10;
        pointer-events: none;
      }
    </style>
  </head>
  <body>
    <div class="caption">“Kaleidoscope”</div>
    <script>
      var colors = ["#ff0000", "#feb30f", "#0aa4f7", "#000000", "#ffffff"];

      var weights = [1, 2, 2, 1, 1, 0];

      var nAgents = 500;

      let agent = [];

      var direction = -1;

      var par = 0;

      let border = -50;

      function setup() {
        createCanvas(800, 800);
        colorMode(HSB, 360, 100, 100, 100);
        strokeCap(SQUARE);

        background(0, 0, 0);

        for (let i = 0; i < nAgents; i++) {
          agent.push(new Agent());
        }
      }

      function draw() {
        if (frameCount > 1500) {
          noLoop();
        }

        for (let i = 0; i < agent.length; i++) {
          agent[i].update();
        }
      }

      class Agent {
        constructor() {
          this.p = createVector(
            random(border, width - border),
            random(border, height - border)
          );

          this.pOld = createVector(this.p.x, this.p.y);

          this.step = 0.5;

          this.scale = 5;

          this.color = generateColor();

          if (random(0, 1) > 0.5) {
            this.direction = 1;
          } else {
            this.direction = -1;
          }

          this.strokeWidth = random(1, 2);
        }

        getPartner() {
          return this.partner;
        }

        getP() {
          return this.p;
        }

        getColor() {
          return this.color;
        }

        update() {
          if (random(0, 1) < 1.0e-4) {
            this.direction *= -1;
          }

          this.p.x +=
            this.direction *
            vector_field(this.p.x, this.p.y, this.scale).x *
            this.step;
          this.p.y +=
            this.direction *
            vector_field(this.p.x, this.p.y, this.scale).y *
            this.step;

          strokeWeight(this.strokeWidth);
          stroke(this.color);

          line(this.pOld.x, this.pOld.y, this.p.x, this.p.y);
        }
      }

      function vector_field(x, y, myScale) {
        x = map(x, 0, width, -myScale, myScale);
        y = map(y, 0, height, -myScale, myScale);

        let k1 = 5;
        let k2 = 3;

        let u = sin(k1 * y) + cos(k2 * y);
        let v = sin(k2 * x) - cos(k1 * x);

        return createVector(u, v);
      }

      function generateColor() {
        let temp = myRandom(colors, weights);

        myColor = color(
          hue(temp) + randomGaussian() * 10,
          saturation(temp) + randomGaussian() * 10,
          brightness(temp) * 0.75,
          random(0, 50)
        );

        return myColor;
      }

      function myRandom(colors, weights) {
        let sum = 0;

        for (let i = 0; i < colors.length; i++) {
          sum += weights[i];
        }

        let rr = random(0, sum);

        for (let j = 0; j < weights.length; j++) {
          if (weights[j] >= rr) {
            return colors[j];
          }
          rr -= weights[j];
        }
      }
    </script>
  </body>
</html>
