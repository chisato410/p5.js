<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>dream</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>
    <style>
      body {
        margin: 0;
        overflow: hidden;
        background-color: #000;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
      }
      canvas {
        display: block;
      }
      .caption {
        position: absolute;
        left: 16px;
        bottom: 16px;
        color: #fff;
        font-family: Helvetica, Arial;
        z-index: 10;
        pointer-events: none;
      }
    </style>
  </head>
  <body>
    <div class="caption">“dream”</div>
    <script>
      let _cellSize = 10;
      let _cellArray = [];
      let _numX, _numY;
      let books = [];
      let stars = [];

      function setup() {
        createCanvas(windowWidth, windowHeight);

        _numX = floor(width / _cellSize);
        _numY = floor(height / _cellSize);
        restart();
        for (let i = 0; i < 8; i++) {
          // 8個方塊
          books.push(new Book(random(width), random(height)));
        }
        for (let i = 0; i < 100; i++) {
          // 100個星星
          stars.push(new Star(random(width), random(height)));
        }
      }

      function restart() {
        // first, create a grid of cells
        for (let x = 0; x < _numX; x++) {
          _cellArray[x] = [];
          for (let y = 0; y < _numY; y++) {
            let newCell = new Cell(x, y);
            _cellArray[x].push(newCell);
          }
        }

        for (let x = 0; x < _numX; x++) {
          for (let y = 0; y < _numY; y++) {
            let above = y - 1;
            let below = y + 1;
            let left = x - 1;
            let right = x + 1;
            if (above < 0) {
              above = _numY - 1;
            }
            if (below === _numY) {
              below = 0;
            }
            if (left < 0) {
              left = _numX - 1;
            }
            if (right === _numX) {
              right = 0;
            }
            _cellArray[x][y].addNeighbour(_cellArray[left][above]);
            _cellArray[x][y].addNeighbour(_cellArray[left][y]);
            _cellArray[x][y].addNeighbour(_cellArray[left][below]);
            _cellArray[x][y].addNeighbour(_cellArray[x][below]);
            _cellArray[x][y].addNeighbour(_cellArray[right][below]);
            _cellArray[x][y].addNeighbour(_cellArray[right][y]);
            _cellArray[x][y].addNeighbour(_cellArray[right][above]);
            _cellArray[x][y].addNeighbour(_cellArray[x][above]);
          }
        }
      }

      function draw() {
        background(247, 202, 201, 100);
        //background(255, 50);

        for (let x = 0; x < _numX; x++) {
          for (let y = 0; y < _numY; y++) {
            _cellArray[x][y].calcNextState();
          }
        }
        for (let x = 0; x < _numX; x++) {
          for (let y = 0; y < _numY; y++) {
            _cellArray[x][y].drawMe();
          }
        }
        for (let book of books) {
          book.update();
          book.display();
        }
        for (let star of stars) {
          star.update();
          star.display();
        }

        //fill(146, 168, 209, 200);
        fill(0, 250);
        rect(0, 0, windowWidth, 50);
        rect(0, windowHeight - 50, windowWidth, 50);
      }

      function mousePressed() {
        //restart();
        for (let book of books) {
          book.reset();
        }
        for (let star of stars) {
          star.reset();
        }
      }

      class Cell {
        constructor(ex, why) {
          this.x = ex * _cellSize;
          this.y = why * _cellSize;
          this.lastState = 0;
          this.nextState = (this.x / width + this.y / height) * 14;

          this.state = this.nextState;
          this.neighbours = [];
        }

        addNeighbour(c) {
          this.neighbours.push(c);
        }

        calcNextState() {
          let total = 0;
          for (let i = 0; i < this.neighbours.length; i++) {
            total += this.neighbours[i].state;
          }
          let average = int(total / 8);
          if (average === 255) {
            this.nextState = 0;
          } else if (average === 0) {
            this.nextState = 150;
          } else {
            this.nextState = this.state + average;
            if (this.lastState > 0) {
              this.nextState -= this.lastState;
            }
            if (this.nextState > 255) {
              this.nextState = 150;
            } else if (this.nextState < 0) {
              this.nextState = 0;
            }
          }
          this.lastState = this.state;
        }

        drawMe() {
          this.state = this.nextState;
          noStroke();

          //fill((this.state), 173, 173,100);
          fill(146, 168, 209, this.state);

          //circle(this.x, this.y, _cellSize * 0.8);
          rect(this.x, this.y, _cellSize * 1.5, _cellSize * 1.5);
        }
      }

      class Book {
        constructor(x, y) {
          this.x = x;
          this.y = y;
          this.vx = random(-1, 1);
          this.vy = random(-1, 1);
          this.angle = 0;
          this.angularSpeed = random(-0.02, 0.02);
        }

        update() {
          this.x += this.vx;
          this.y += this.vy;
          this.angle += this.angularSpeed;

          if (this.x < 0 || this.x > width) {
            this.vx *= -1;
          }
          if (this.y < 0 || this.y > height) {
            this.vy *= -1;
          }
        }

        display() {
          push();
          translate(this.x, this.y);
          rotate(this.angle);
          fill(129, 155, 202, 200);
          rect(-10, -10, 20, 20);
          pop();
        }

        reset() {
          this.x = random(width);
          this.y = random(height);
          this.vx = random(-1, 1);
          this.vy = random(-1, 1);
          this.angle = 0;
          this.angularSpeed = random(-0.02, 0.02);
        }
      }

      class Star {
        constructor(x, y) {
          this.x = x;
          this.y = y;
          this.vx = random(-0.5, 0.5);
          this.vy = random(-0.5, 0.5);
        }

        update() {
          this.x += this.vx;
          this.y += this.vy;

          if (this.x < 0 || this.x > width) {
            this.vx *= -1;
          }
          if (this.y < 0 || this.y > height) {
            this.vy *= -1;
          }
        }

        display() {
          push();
          translate(this.x, this.y);
          fill(250, 224, 224, 200);
          noStroke();
          ellipse(0, 0, 5, 5);
          pop();
        }

        reset() {
          this.x = random(width);
          this.y = random(height);
          this.vx = random(-0.5, 0.5);
          this.vy = random(-0.5, 0.5);
        }
      }
    </script>
  </body>
</html>
